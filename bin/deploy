#!/usr/bin/env bash
set -euo pipefail

source ./bin/config.sh

if [[ "${AWS_ACCESS_KEY_ID:-}" == "" ]]
then
  # green "==> This current environment"
  # export

  export AWS_SECRET_ACCESS_KEY="${DEPLOY_APPLICATION_USER_AWS_SECRET_ACCESS_KEY}"
  export AWS_ACCESS_KEY_ID="${DEPLOY_APPLICATION_USER_AWS_ACCESS_KEY_ID}"
  export AWS_ACCOUNT_ID="563660588778"

  temp_role="$(aws sts assume-role --role-arn arn:aws:iam::${AWS_ACCOUNT_ID}:role/DiDeploy --role-session-name config-deploy)"
  export AWS_ACCESS_KEY_ID=$(echo ${temp_role}     | jq -r .Credentials.AccessKeyId)
  export AWS_SECRET_ACCESS_KEY=$(echo ${temp_role} | jq -r .Credentials.SecretAccessKey)
  export AWS_SESSION_TOKEN=$(echo $temp_role       | jq -r .Credentials.SessionToken)
else
  green "==> Reusing existing AWS creds"
fi

green "==> Who am I"
aws sts get-caller-identity

green "==> Logging in into ECR"
aws ecr get-login-password \
  --region eu-north-1 \
  | docker login \
    --username AWS \
    --password-stdin \
    563660588778.dkr.ecr.eu-north-1.amazonaws.com

green "==> Pushing $IMAGE_LATEST"
docker push $IMAGE_LATEST
